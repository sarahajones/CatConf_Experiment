<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CatConf-Experiment</title>

    <!--jsPsych-->
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-same-different-image.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-slider-response.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css">

    <!--jQuery and jQuery plugins -->
    <script src="scripts/external/jquery-3.4.1.min.js"></script>
    <script src="scripts/external/jquery-3.4.1.js"></script>
    <script src="scripts/external/jquery.mousewheel.min.js"></script>
    <script src="scripts/external/jquery.scrollify.js"></script>

    <!--custom JS: trials-->
    <script src="scripts/jspsych-PIS.js"></script>
    <script src="scripts/jspsych-consent.js"></script>
    <script src="scripts/jspsych-tutorial.js"></script>
    <script src="scripts/jspsych-splashmessage.js"></script>
    <script src="scripts/jspsych-quickfire.js"></script>
    <script src="scripts/jspsych-experimentscreen.js"></script>

    <script src="scripts/trial.js"></script>
    <script src="scripts/helper-functions.js"></script>
    <script src="scripts/box-muller.js"></script>
    <script src="scripts/gaussian.js"></script>

    <!--custom CSS-->
    <link href="CSS/styles.css" rel="stylesheet" type="text/css">
    <link href="CSS/experimentscreen.css" rel="stylesheet" type="text/css">

</head>

<body class="main">

<script>

    /* EXPERIMENT INFORMATION */
    var CUREC_studyName = 'An investigation into decision confidence and category choices';
    var CUREC_ID = '___________';
    var PIS_version = '1.0';
    var PIS_date = 'August 2020';
    var consent_version = '1.0';
    var consent_date = 'August 2020';

    /* PreLOAD IMAGES FOR SPEED */
    var images = [
        'images/oxford-logo.jpg' +
        'images/checkmark-black.svg' +
        'images/checkmark-white.svg' +
        'images/space_invaders.png' +
        'images/green_spaceship.png' +
        'images/blue_spaceship.png' +
        'images/orange_spaceship.png' +
        'images/bomb.png' +
        'images/coins.png'
    ];

    var dataObject = {
        CUREC_ID: CUREC_ID,
        PIS_version: PIS_version,
        PIS_date: PIS_date,
        PIS_acknowledged: undefined,
        consent_version: consent_version,
        consent_date: consent_date,
        consented: undefined,
    };
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* EXPERIMENTAL PAGES */
    // PIS
    var PIS = {
        type: 'jspsych-PIS',
        studyName: CUREC_studyName,
        CUREC_ID: CUREC_ID,
        version: PIS_version,
        date: PIS_date
    };

    var consent = {
        type: 'jspsych-consent',
        studyName: CUREC_studyName,
        CUREC_ID: CUREC_ID,
        version: consent_version,
        date: consent_date
    };
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* TRAINING AND INSTRUCTION*/
    var tutorial_1 = {
        type: "jspsych-tutorial",
        isFirstTime: true
    };

    var tutorial_2 = {
        type: "jspsych-tutorial",
        isSecondTime: true
    };

    var tutorial_3 = {
        type: "jspsych-tutorial",
        isThirdTime: true
    };

    var splash_1 = {
        type: "jspsych-splashmessage",
        trial_type: 'Loading',
        //display_duration: 3500,
        trial_duration: 3750,
    };
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* EXPERIMENT TIMELINE*/
    const intro_timeline = [
        //PIS,
        //consent,
        //tutorial_1,
        //tutorial_2,
        //tutorial_3,
        splash_1,
    ];
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*QUICK FIRE ROUND*/
    const quickfire_timeline = [];
    const trial_number = 6; // No magic numbers! :)

    // construct deck
    quickfire_stimuli = [
        'images/orange_spaceship.png',
        'images/blue_spaceship.png'
    ];

    const deck_count = trial_number / quickfire_stimuli.length;

    // shuffle deck
    quickfire_stimuli = shuffle_shoe(quickfire_stimuli, deck_count);

    let trial_contents = quickfire_stimuli.map(
        s => {
            const outcome_chance = 1;
            const good = 'images/coins.png';
            const bad = 'images/bomb.png';
            let r;

            if(/orange/i.test(s)) {
                r = Math.random() < outcome_chance ? good : bad;
            } else if(/blue/i.test(s)) {
                r = Math.random() > outcome_chance ? good : bad;
            } else {
                console.warn(`Unrecognised spaceship colour in ${s}.`);
                return;
            }
            return {
                stimulus: s,
                result: r
            }
        });

    for(let i=1; i <= trial_number; i++) {
        const trial_details = trial_contents.pop();
        quickfire_timeline.push({
            type: 'jspsych-quickfire',
            stimuli: [trial_details.stimulus, 'images/package_image.png'],
            feedback: trial_details.result,
            trial_number: i,
            choices: ['Retrieve', 'Zap'],
            stimulus1_duration: 1500,
            gap_duration: 0,
            stimulus2_duration: 1500,
            trial_duration: 5000,
            feedback_duration: 2000,
            response_ends_trial: false,
        });
    }
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Next set of instructions and splash message while loading screen*/

    var tutorial_4 = {
        type: "jspsych-tutorial",
        isFourthTime: true
    };

    var splash_2 = {
        type: "jspsych-splashmessage",
        trial_type: 'Loading',
        //display_duration: 3500,
        trial_duration: 3750,
    };

    const interim1_timeline = [
      tutorial_4,
      splash_2
    ];


    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*FAST DROP LEARNING*/
    const fastdrop_timeline = [];
    const fastdrop_number = 10; //amount of drops

    const fastdrop_distribution = [
        {name: 'narrow', value: gaussian(200, 5000), color: 'blue'},
        {name: 'wide', value: gaussian(500, 10000), color: 'orange'}
    ];

    // create deck count for spaceship drops
    const fastdrop_deck_count = fastdrop_number / fastdrop_distribution.length;

    // shuffle deck
    const fastdrop_stimuli = shuffle_shoe(fastdrop_distribution, fastdrop_deck_count);


    // on each trial loop through stimuli info, pull values and pass to plugin
    fastdrop_stimuli.forEach(s => {
        fastdrop_timeline.push({
            type: "jspsych-experimentscreen",
            trial_type: 'clear',
            confidence_trial: false,
            trial_duration: 2000,
            choices: [],
            location: s.value.random(1)[0],
            stimulus_duration: 1500,
            spaceship_class: s.color,
            distribution_name: s.name,
            banner: 1,
            banner_text: 'Please watch carefully'
        })
    });

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*TEST TRIALS*/
    const cloud_timeline = [];

    const drop_number = 4; //amount of drops

    const distribution = [
        {name: 'narrow', value: gaussian(200, 5000), color: 'greenyellow'},
        {name: 'wide', value: gaussian(500, 10000), color: 'red'}
    ];

    // create deck count for spaceship drops
    const spaceship_deck_count = drop_number / distribution.length;

    // shuffle deck
    const spaceship_stimuli = shuffle_shoe(distribution, spaceship_deck_count);


    // on each trial loop through stimuli info, pull values and pass to plugin
    spaceship_stimuli.forEach(s => {
        cloud_timeline.push({
            type: "jspsych-experimentscreen",
            trial_duration: 5000,
            choices: ['Retrieve', 'Zap'],
            location: s.value.random(1)[0],
            stimulus_duration: 3000,
            spaceship_class: s.color,
            distribution_name: s.name,
            confidence_trial: true,
            trial_type: 'unclear'
        })
    });



    const timeline = [
        ...intro_timeline,
        ...quickfire_timeline,
        ...interim1_timeline,
        ...fastdrop_timeline,
        ...cloud_timeline,
    ];
    console.log({timeline});

    /* start the experiment */
    jsPsych.init({
        timeline: timeline
    })


</script>
</body>
</html>