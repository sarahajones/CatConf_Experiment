<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CatConf-Experiment</title>

    <!--jsPsych-->
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-same-different-image.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-slider-response.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css">

    <!--jQuery and jQuery plugins -->
    <script src="scripts/external/jquery-3.4.1.min.js"></script>
    <script src="scripts/external/jquery-3.4.1.js"></script>
    <script src="scripts/external/jquery.mousewheel.min.js"></script>
    <script src="scripts/external/jquery.scrollify.js"></script>

    <!--custom JS: trials-->
    <script src="scripts/jspsych-PIS.js"></script>
    <script src="scripts/jspsych-consent.js"></script>
    <script src="scripts/jspsych-tutorial.js"></script>
    <script src="scripts/jspsych-splashmessage.js"></script>
    <script src="scripts/jspsych-quickfire.js"></script>
    <script src="scripts/jspsych-experimentscreen.js"></script>
    <script src="scripts/jspsych-demographics.js"></script>
    <script src="scripts/jspsych-lastScreen.js"></script>
    <script src="scripts/jspsych-feedback.js"></script>
    <script src="scripts/jspsych-feedback-form.js"></script>

    <!--custom JS: helpers-->
    <script src="scripts/helper-functions.js"></script>
    <script src="scripts/box-muller.js"></script>
    <script src="scripts/gaussian.js"></script>


    <!--custom CSS-->
    <link href="CSS/styles.css" rel="stylesheet" type="text/css">
    <link href="CSS/experimentscreen.css" rel="stylesheet" type="text/css">

</head>

<body class="main">

<script>

    /* EXPERIMENT INFORMATION */
    var CUREC_studyName = 'An investigation into decision confidence and category choices';
    var CUREC_ID = 'R68879/RE001';
    var PIS_version = '1.0';
    var PIS_date = 'September 2020';
    var consent_version = '1.0';
    var consent_date = 'September 2020';

    /* PreLOAD IMAGES FOR SPEED */
    var images = [
        'images/oxford-logo.jpg' +
        'images/checkmark-black.svg' +
        'images/checkmark-white.svg' +
        'images/space_invaders.png' +
        'images/green_spaceship.png' +
        'images/blue_spaceship.png' +
        'images/orange_spaceship.png' +
        'images/resized_blue_spaceship.png' +
        'images/resized_orange_spaceship.png' +
        'images/bomb.png' +
        'images/coins.png' +
        'images/package_image.png' +
        'images/zap1.png' +
        'images/zap2.png'
    ];

    /* EXPERIMENT VARIABLES */
    const trial_number = 20 ; //20//quickfire round trial number
    const fastdrop_number = 50; //50//amount of drops in fast drop blocks
    const drop_number = 45; //45//amount of drops in test trial blocks

    const distribution1_1 = [
        {name: 'narrow', value: gaussian(200, 5000), color: 'blue1'},
        {name: 'wide', value: gaussian(500, 10000), color: 'orange1'}
    ];
    const distribution2_1 = [
        {name: 'narrow', value: gaussian(500, 5000), color: 'blue1'},
        {name: 'wide', value: gaussian(200, 10000), color: 'orange1'}
    ];
    const distribution3_1 = [
        {name: 'wide', value: gaussian(500, 5000), color: 'blue1'},
        {name: 'narrow', value: gaussian(200, 10000), color: 'orange1'}
    ];
    const distribution4_1 = [
        {name: 'wide', value: gaussian(200, 5000), color: 'blue1'},
        {name: 'narrow', value: gaussian(500, 10000), color: 'orange1'}
    ];

    distributions = [distribution1_1, distribution2_1, distribution3_1, distribution4_1];
    indices = [0, 1, 2, 3]
    index = shuffle(indices)
    console.log()

    // QUICKFIRE LEARNING ROUND
    quickfire_stimuli = [
        'images/orange_spaceship.png',
        'images/blue_spaceship.png'
    ];
    const deck_count = trial_number / quickfire_stimuli.length;
    quickfire_stimuli = shuffle_shoe(quickfire_stimuli, deck_count); //shuffle deck

    //GAME BLOCK 1
    const distribution1 = distributions[index[0]];
    //FASTDROP 1 TRIALS
    const fastdrop_deck_count = fastdrop_number / distribution1.length; // create deck count for spaceship drops
    const fastdrop_stimuli = shuffle_shoe(distribution1, fastdrop_deck_count); // shuffle deck
    //BLOCK 1 TEST TRIALS
    const spaceship_deck_count1 = drop_number / distribution1.length; // create deck count for spaceship drops
    const spaceship_stimuli1 = shuffle_shoe(distribution1, spaceship_deck_count1); // shuffle deck


    //GAME BLOCK 2
    const distribution2 = distributions[index[1]];
    //FASTDROP 2 TRIALS
    const fastdrop_deck_count2 = fastdrop_number / distribution2.length;
    const fastdrop_stimuli2 = shuffle_shoe(distribution2, fastdrop_deck_count2);
    //BLOCK 2 TEST TRIALS
    const spaceship_deck_count2 = drop_number / distribution2.length;
    const spaceship_stimuli2 = shuffle_shoe(distribution2, spaceship_deck_count2);


    //GAME BLOCK 3
    const distribution3 = distributions[index[2]];
    //FASTDROP 3 TRIALS
    const fastdrop_deck_count3 = fastdrop_number/ distribution3.length;
    const fastdrop_stimuli3 = shuffle_shoe(distribution3, fastdrop_deck_count3);
    //BLOCK 3 TEST TRIALS
    const spaceship_deck_count3 = drop_number / distribution3.length;
    const spaceship_stimuli3 = shuffle_shoe(distribution3, spaceship_deck_count3);

    //GAME BLOCK 4
    const distribution4 = distributions[index[3]];
    //FASTDROP 4 TRIALS
    const fastdrop_deck_count4 = fastdrop_number/ distribution4.length;
    const fastdrop_stimuli4 = shuffle_shoe(distribution4, fastdrop_deck_count4);
    //BLOCK 4 TEST TRIALS
    const spaceship_deck_count4 = drop_number / distribution4.length;
    const spaceship_stimuli4 = shuffle_shoe(distribution4, spaceship_deck_count4);


    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* EXPERIMENTAL PAGES */
    //splash loading screen
    var splash_1 = {
        type: "jspsych-splashmessage",
        trial_type: 'Loading',
        trial_duration: 3750,
    };

    // PIS
    var PIS = {
        type: 'jspsych-PIS',
        studyName: CUREC_studyName,
        CUREC_ID: CUREC_ID,
        version: PIS_version,
        date: PIS_date
    };
    // CONSENT
    var consent = {
        type: 'jspsych-consent',
        studyName: CUREC_studyName,
        CUREC_ID: CUREC_ID,
        version: consent_version,
        date: consent_date
    };

    //DEMOGRAPHICS
    var demographics = {
        type: 'jspsych-demographics'
    };

    /* TRAINING AND INSTRUCTION*/
    var tutorial_1 = {
        type: "jspsych-tutorial",
        isFirstTime: true
    };

    var tutorial_2 = {
        type: "jspsych-tutorial",
        isSecondTime: true
    };

    var tutorial_3 = {
        type: "jspsych-tutorial",
        isThirdTime: true
    };


    /* EXPERIMENT TIMELINE*/
    const intro_timeline = [
        splash_1, //happy
        PIS, //saving?
        consent, //saving?
        splash_1, //happy
        demographics, //saving?
        tutorial_1, //happy
        tutorial_2, //happy
        tutorial_3, //happy
        splash_1, //happy
    ];

    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*QUICK FIRE ROUND - TRIAL NUMBER 25*/
    const quickfire_timeline = [];

    let trial_contents = quickfire_stimuli.map(
        s => {
            const outcome_chance = 1;
            const good = 'images/coins.png';
            const bad = 'images/bomb.png';
            let r;

            if (/orange/i.test(s)) {
                r = Math.random() < outcome_chance ? good : bad;
            } else if (/blue/i.test(s)) {
                r = Math.random() > outcome_chance ? good : bad;
            } else {
                console.warn(`Unrecognised spaceship colour in ${s}.`);
                return;
            }
            return {
                stimulus: s,
                result: r
            }
        });

    for (let i = 1; i <= trial_number; i++) {
        const trial_details = trial_contents.pop();
        quickfire_timeline.push({
            type: 'jspsych-quickfire',
            stimuli: [trial_details.stimulus, 'images/package_image.png'],
            feedback: trial_details.result,
            trial_number: i,
            choices: ['Retrieve', 'Zap'],
            stimulus1_duration: 1500,
            gap_duration: 0,
            stimulus2_duration: 1500,
            trial_duration: 10000,
            feedback_duration: 2000,
            response_ends_trial: false,
            Zap1: 'images/zap1.png',
            Zap2: 'images/zap2.png',
        });
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Next set of instructions and splash message while loading screen*/
    var tutorial_4 = {
        type: "jspsych-tutorial",
        isFourthTime: true
    };

    const interim1_timeline = [
        tutorial_4,
        splash_1
    ];

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*FAST DROP LEARNING - TRIAL NUMBER 50*/
    const fastdrop_timeline = [];

    // on each trial loop through stimuli info, pull values and pass to plugin
    fastdrop_stimuli.forEach(s => {
        if (/blue/i.test(s.color)) {
            s.spaceship_image = "../images/blue_spaceship.png"
            s.color1 = 'blue';
        } else {
            s.spaceship_image = "../images/orange_spaceship.png"
            s.color1 = 'orange';
        }

        do{
            s.location = s.value.random(1)[0];
        } while (s.location < 15 | s.location > 785)

        fastdrop_timeline.push({
            type: "jspsych-experimentscreen",
            trial_type: 'clear',
            confidence_trial: false,
            trial_duration: 2000,
            choices: [],
            location: s.location,
            stimulus_duration: 1500,
            spaceship_class: s.color1,
            spaceship_image: s.spaceship_image,
            distribution_name: s.name,
            distribution_info: s.value,
            banner: 1,
            banner_text: 'Please watch carefully',
            block: 0
        })
    });

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Next set of instructions and splash message while loading screen*/
    var tutorial_5 = {
        type: "jspsych-tutorial",
        isFifthTime: true
    };

    var tutorial_6 = {
        type: "jspsych-tutorial",
        isSixthTime: true
    };

    var splash_2 = {
        type: "jspsych-splashmessage",
        trial_type: 'Next',
        //display_duration: 3500,
        trial_duration: 3750,
    };

    const interim2_timeline = [
        splash_1,
        tutorial_5,
        tutorial_6,
        splash_2
    ];
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*TEST TRIALS 1*/
    const cloud1_timeline = [];

    // on each trial loop through stimuli info, pull values and pass to plugin
    spaceship_stimuli1.forEach(s => {
        do{
            s.location = s.value.random(1)[0];
        } while (s.location < 15 | s.location > 785)
        cloud1_timeline.push({
            type: "jspsych-experimentscreen",
            trial_duration: 10000,
            choices: ['Retrieve', 'Zap'],
            location: s.location,
            stimulus_duration: 3000,
            spaceship_class: s.color,
            distribution_name: s.name,
            distribution_info: s.value,
            confidence_trial: true,
            trial_type: 'unclear',
            block: 1,
        })
    });

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* block feedback */
    let feedback1_timeline = [];
    var feedback1 = {
        type: "jspsych-feedback",
        trial_type: 'first',
        filter_fun: (x) =>
            x.trial_type === "jspsych-experimentscreen" && x.block === 1
    };

    feedback1_timeline = [
        feedback1
    ];
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Next set of instructions and splash message while loading screen*/
    var tutorial_7 = {
        type: "jspsych-tutorial",
        isSeventhTime: true
    };

    const interim3_timeline = [
        splash_1,
        tutorial_7,
        splash_2
    ];
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*FAST DROP LEARNING - TRIAL NUMBER 50*/
    const fastdrop2_timeline = [];

    // on each trial loop through stimuli info, pull values and pass to plugin
    fastdrop_stimuli2.forEach(s => {
        if (/blue/i.test(s.color)) {
            s.spaceship_image = "../images/blue_spaceship.png"
            s.color1 = 'blue';
        } else {
            s.spaceship_image = "../images/orange_spaceship.png"
            s.color1 = 'orange';
        }
        do{
            s.location = s.value.random(1)[0];
        } while (s.location < 15 | s.location > 785)
        fastdrop2_timeline.push({
            type: "jspsych-experimentscreen",
            trial_type: 'clear',
            confidence_trial: false,
            trial_duration: 2000,
            choices: [],
            location: s.location,
            stimulus_duration: 1500,
            spaceship_class: s.color1,
            spaceship_image: s.spaceship_image,
            distribution_name: s.name,
            distribution_info: s.value,
            banner: 1,
            banner_text: 'Please watch carefully',
            block: -1
        })
    });
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Interim timeline*/
    const interim4_timeline = [
    splash_2,
    ];

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*TEST TRIALS 2*/
    const cloud2_timeline = [];

    // on each trial loop through stimuli info, pull values and pass to plugin
    spaceship_stimuli2.forEach(s => {
        do{
            s.location = s.value.random(1)[0];
        } while (s.location < 15 | s.location > 785)
        cloud2_timeline.push({
            type: "jspsych-experimentscreen",
            trial_duration: 10000,
            choices: ['Retrieve', 'Zap'],
            location: s.location,
            stimulus_duration: 3000,
            spaceship_class: s.color,
            distribution_name: s.name,
            distribution_info: s.value,
            confidence_trial: true,
            trial_type: 'unclear',
            block: 2
        })
    });
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* block feedback */
    var feedback2_timeline = [];

    var feedback2 = {
        type: "jspsych-feedback",
        trial_type: 'second',
        filter_fun: (x) =>
            x.trial_type === "jspsych-experimentscreen" && x.block === 2
    };

    feedback2_timeline = [
        feedback2
    ];


    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Next set of instructions and splash message while loading screen*/
    //interim 3 timeline repeated

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*FAST DROP LEARNING - TRIAL NUMBER 50*/
    const fastdrop3_timeline = [];

    // on each trial loop through stimuli info, pull values and pass to plugin
    fastdrop_stimuli3.forEach(s => {
        if (/blue/i.test(s.color)) {
            s.spaceship_image = "../images/blue_spaceship.png"
            s.color1 = 'blue';
        } else {
            s.spaceship_image = "../images/orange_spaceship.png"
            s.color1 = 'orange';
        }
        do{
            s.location = s.value.random(1)[0];
        } while (s.location < 15 | s.location > 785)
        fastdrop3_timeline.push({
            type: "jspsych-experimentscreen",
            trial_type: 'clear',
            confidence_trial: false,
            trial_duration: 2000,
            choices: [],
            location: s.location,
            stimulus_duration: 1500,
            spaceship_class: s.color1,
            spaceship_image: s.spaceship_image,
            distribution_name: s.name,
            distribution_info: s.value,
            banner: 1,
            banner_text: 'Please watch carefully',
            block: -2
        })
    });
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Interim*/
    //interim 4 timeline repeated
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*TEST TRIALS 3*/
    const cloud3_timeline = [];

    // on each trial loop through stimuli info, pull values and pass to plugin
    spaceship_stimuli3.forEach(s => {
        do{
            s.location = s.value.random(1)[0];
        } while (s.location < 15 | s.location > 785)
        cloud3_timeline.push({
            type: "jspsych-experimentscreen",
            trial_duration: 10000,
            choices: ['Retrieve', 'Zap'],
            location: s.location,
            stimulus_duration: 3000,
            spaceship_class: s.color,
            distribution_name: s.name,
            distribution_info: s.value,
            confidence_trial: true,
            trial_type: 'unclear',
            block: 3
        })
    });
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* block feedback */
    var feedback3_timeline = [];

    var feedback3 = {
        type: "jspsych-feedback",
        trial_type: 'third',
        filter_fun: (x) =>
            x.trial_type === "jspsych-experimentscreen" && x.block === 3
    };

    feedback3_timeline = [
        feedback3
    ];


    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Interim*/

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*FAST DROP LEARNING - TRIAL NUMBER 50*/
    const fastdrop4_timeline = [];

    // on each trial loop through stimuli info, pull values and pass to plugin
    fastdrop_stimuli4.forEach(s => {
        if (/blue/i.test(s.color)) {
            s.spaceship_image = "../images/blue_spaceship.png"
            s.color1 = 'blue';
        } else {
            s.spaceship_image = "../images/orange_spaceship.png"
            s.color1 = 'orange';
        }
        do{
            s.location = s.value.random(1)[0];
        } while (s.location < 15 | s.location > 785)
        fastdrop4_timeline.push({
            type: "jspsych-experimentscreen",
            trial_type: 'clear',
            confidence_trial: false,
            trial_duration: 2000,
            choices: [],
            location: s.location,
            stimulus_duration: 1500,
            spaceship_class: s.color1,
            spaceship_image: s.spaceship_image,
            distribution_name: s.name,
            distribution_info: s.value,
            banner: 1,
            banner_text: 'Please watch carefully',
            block: -3
        })
    });
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Interim*/

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*TEST TRIALS 3*/
    const cloud4_timeline = [];

    // on each trial loop through stimuli info, pull values and pass to plugin
    spaceship_stimuli4.forEach(s => {
        do{
            s.location = s.value.random(1)[0];
        } while (s.location < 15 | s.location > 785)
        cloud4_timeline.push({
            type: "jspsych-experimentscreen",
            trial_duration: 10000,
            choices: ['Retrieve', 'Zap'],
            location: s.location,
            stimulus_duration: 3000,
            spaceship_class: s.color,
            distribution_name: s.name,
            distribution_info: s.value,
            confidence_trial: true,
            trial_type: 'unclear',
            block: 4
        })
    });
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* block feedback */
    var feedback4_timeline = [];

    var feedback4 = {
        type: "jspsych-feedback",
        trial_type: 'last',
        filter_fun: (x) =>
            x.trial_type === "jspsych-experimentscreen" && x.block === 4
    };

    feedback4_timeline = [
        feedback4
    ];
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*sign off experiment*/
    var splash_3 = {
        type: "jspsych-splashmessage",
        trial_type: 'Last',
        trial_duration: 3000,
    };

    var feedbackForm = {
        type: 'jspsych-feedback-form',
    };

    var end_experiment = {
        type: "jspsych-lastScreen",
    };

    end_timeline = [
        splash_3,
        feedbackForm,
        end_experiment
    ];

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    var interim_fast = {
        type: 'jspsych-splashmessage',
        trial_type: 'fastdrop',
        trial_duration: 3000
    };
    interim_fast =[
        interim_fast
    ];

    var interim_cloud = {
        type: 'jspsych-splashmessage',
        trial_type: 'cloud',
        trial_duration: 3000
    };
    interim_cloud = [
        interim_cloud
    ];
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* Set up timeline and launch experiment*/

    const timeline = [
        ...intro_timeline, //happy, check on saving of pp info and consent etc
        /*...quickfire_timeline, //happy
        ...interim1_timeline, //gif will need updating, has been removed for now.
        ...fastdrop_timeline, //
        ...interim2_timeline, //
        ...cloud1_timeline, //happy - slider labels could use more padding but okay
        ...feedback1_timeline, //Happy
        ...interim3_timeline, //little bit messy on screen but likely updated
        ...interim_fast,
        ...fastdrop2_timeline, //
        ...interim_cloud,
        ...cloud2_timeline, //happy - slider labels could use more padding but okay
        ...feedback2_timeline,//
        ...interim3_timeline,//little bit messy on screen but likely updated
        ...interim_fast,
        ...fastdrop3_timeline, //
        ...interim_cloud,
        ...cloud3_timeline, //happy - slider labels could use more padding but okay
        ...feedback3_timeline, //
        ...interim3_timeline,//
        ...interim_fast,
        ...fastdrop4_timeline, //
        ...interim_cloud,
        ...cloud4_timeline, //happy - slider labels could use more padding but okay
        ...feedback4_timeline,*/ //
        ...end_timeline
    ];

    test_save();

    /* start the experiment */
    jsPsych.init({
        timeline: timeline,
        on_finish: save_csv
    });

    /**
     * Save the jsPsych CSV output to the server
     */
    function save_csv() {
        // Get a user ID
        let id = jsPsych.data.getURLVariable('PROLIFIC_ID');
        if(typeof id !== "string")
            id = "ID" + Math.floor(Math.random() * 100) +
                "T" + Math.floor(performance.timeOrigin);

        jsPsych.data.addProperties({user_id: id});

        // Fetch all the experiment data and send it to the server
        const data = {
            user_id: id,
            experiment: 'zapBox',
            version: [0, 1, 0],
            csv: jsPsych.data.get().csv()
        };

        fetch(
            "savecsv.php",
            {
                method: "POST",
                body: JSON.stringify(data),
                type: 'application/json'
            }
        )
            .then(r => r.text())
            .then(b => console.log(b));
    }

    /**
     * Test the ability to save files on the server
     */
    function test_save() {
        fetch(
            "savecsv.php",
            {
                method: "POST",
                body: JSON.stringify({user_id: "test_id"}),
                type: 'application/json'
            }
        )
            .then(r => {
                if(r.status !== 200)
                    console.error('Problem saving data');
                else
                    console.log('Save data test okay!');
            });
    }
</script>
</body>
</html>