<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CatConf-Experiment</title>

    <!--jsPsych-->
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-same-different-image.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-slider-response.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css">

    <!--jQuery and jQuery plugins -->
    <script src="scripts/external/jquery-3.4.1.min.js"></script>
    <script src="scripts/external/jquery-3.4.1.js"></script>
    <script src="scripts/external/jquery.mousewheel.min.js"></script>
    <script src="scripts/external/jquery.scrollify.js"></script>

    <!--custom JS: trials-->
    <script src="scripts/jspsych-PIS.js"></script>
    <script src="scripts/jspsych-consent.js"></script>
    <script src="scripts/jspsych-tutorial.js"></script>
    <script src="scripts/jspsych-splashmessage.js"></script>
    <script src="scripts/jspsych-quickfire.js"></script>
    <script src="scripts/jspsych-experimentscreen.js"></script>
    <script src="scripts/jspsych-demographics.js"></script>
    <script src="scripts/jspsych-lastScreen.js"></script>
    <script src="scripts/jspsych-feedback.js"></script>
    <script src="scripts/jspsych-feedback-form.js"></script>

    <!--custom JS: helpers-->
    <script src="scripts/helper-functions.js"></script>
    <script src="scripts/box-muller.js"></script>
    <script src="scripts/gaussian.js"></script>


    <!--custom CSS-->
    <link href="CSS/styles.css" rel="stylesheet" type="text/css">
    <link href="CSS/experimentscreen.css" rel="stylesheet" type="text/css">

</head>

<body class="main">
    <div id="save-error">
        <h1>Error</h1>
        <p>There was an error testing whether data from the experiment could be saved to the server.
            If you would still like to participate, please contact the study lead on Prolific and we will try to figure out the issue for you. </p>
    </div>
<script>

    /* EXPERIMENT INFORMATION */
    var CUREC_studyName = 'An investigation into decision confidence and category choices';
    var CUREC_ID = 'R68879/RE001';
    var PIS_version = '1.0';
    var PIS_date = 'September 2020';
    var consent_version = '1.0';
    var consent_date = 'September 2020';

    /* PreLOAD IMAGES FOR SPEED */
    var images = [
        'images/oxford-logo.jpg' +
        'images/checkmark-black.svg' +
        'images/checkmark-white.svg' +
        'images/space_invaders.png' +
        'images/green_spaceship.png' +
        'images/blue_spaceship.png' +
        'images/orange_spaceship.png' +
        'images/resized_blue_spaceship.png' +
        'images/resized_orange_spaceship.png' +
        'images/bomb.png' +
        'images/coins.png' +
        'images/package_image.png' +
        'images/zap1.png' +
        'images/zap2.png'
    ];

    /* EXPERIMENT VARIABLES */
    const trial_number = 20 ; //20//quickfire round trial number
    const fastdrop_number = 60; //6mount of drops in fast drop blocks
    const drop_number = 60; //60//amount of drops in test trial blocks

    const distribution1_1 = [
        {name: 'narrow', value: gaussian(222, 6400), color: 'blue1'}, //SD 80, var 6400
        {name: 'wide', value: gaussian(522, 19600), color: 'orange1'} //SD 140, var 19600
    ];
    const distribution2_1 = [
        {name: 'narrow', value: gaussian(622, 6400), color: 'blue1'}, //recenter distributions on 350 (+22 on means)
        {name: 'wide', value: gaussian(322, 19600), color: 'orange1'} //push midpoint to 450
    ];
    const distribution3_1 = [
        {name: 'wide', value: gaussian(522, 19600), color: 'blue1'}, //recenter distributions on 350 (+22 on means)
        {name: 'narrow', value: gaussian(222, 6400), color:'orange1'} //recenter distributions on 350 (+22 on means)
    ];
    const distribution4_1 = [
        {name: 'wide', value: gaussian(322, 19600), color: 'blue1'}, //push midpoint to 450
        {name: 'narrow', value: gaussian(622, 6400), color: 'orange1'} //recenter distributions on 350 (+22 on means)
    ];

    distributions = [distribution1_1, distribution2_1, distribution3_1, distribution4_1];
    indices = [0, 1, 2, 3];
    index = shuffle(indices);

    // QUICKFIRE LEARNING ROUND
    quickfire_stimuli = [
        'images/orange_spaceship.png',
        'images/blue_spaceship.png'
    ];
    const deck_count = trial_number / quickfire_stimuli.length;
    quickfire_stimuli = shuffle_shoe(quickfire_stimuli, deck_count); //shuffle deck

    //GAME BLOCK 1
    const distribution1 = distributions[index[0]];
    const means1 = [distribution1[0].value.mean , distribution1[1].value.mean];
    const stds1 = [distribution1[0].value.standardDeviation, distribution1[1].value.standardDeviation];
    const lowMean1 = Math.min(means1[0], means1[1]);
    const highMean1 = Math.max(means1[0], means1[1]);
    const narrowIndex = stds1.indexOf(Math.min(...stds1));
    const wideIndex = stds1.indexOf(Math.max(...stds1));
    //FASTDROP 1 TRIALS
    const fastdrop_deck_count = fastdrop_number / distribution1.length; // create deck count for spaceship drops
    const fastdrop_stimuli = shuffle_shoe(distribution1, fastdrop_deck_count); // shuffle deck
    //BLOCK 1 TEST TRIALS
    const spaceship_deck_count1 = drop_number / distribution1.length; // create deck count for spaceship drops
    const spaceship_stimuli1 = shuffle_shoe(distribution1, spaceship_deck_count1); // shuffle deck


    //GAME BLOCK 2
    const distribution2 = distributions[index[1]];
    const means2 = [distribution2[0].value.mean , distribution2[1].value.mean];
    const stds2 = [distribution2[0].value.standardDeviation, distribution2[1].value.standardDeviation];
    const lowMean2 = Math.min(means2[0], means2[1]);
    const highMean2 = Math.max(means2[0], means2[1]);
    const narrowIndex2 = stds2.indexOf(Math.min(...stds2));
    const wideIndex2 = stds2.indexOf(Math.max(...stds2));
    //FASTDROP 2 TRIALS
    const fastdrop_deck_count2 = fastdrop_number / distribution2.length;
    const fastdrop_stimuli2 = shuffle_shoe(distribution2, fastdrop_deck_count2);
    //BLOCK 2 TEST TRIALS
    const spaceship_deck_count2 = drop_number / distribution2.length;
    const spaceship_stimuli2 = shuffle_shoe(distribution2, spaceship_deck_count2);


    //GAME BLOCK 3
    const distribution3 = distributions[index[2]];
    const means3 = [distribution3[0].value.mean , distribution3[1].value.mean];
    const stds3 = [distribution3[0].value.standardDeviation, distribution3[1].value.standardDeviation];
    const lowMean3 = Math.min(means3[0], means3[1]);
    const highMean3 = Math.max(means3[0], means3[1]);
    const narrowIndex3 = stds3.indexOf(Math.min(...stds3));
    const wideIndex3 = stds3.indexOf(Math.max(...stds3));
    //FASTDROP 3 TRIALS
    const fastdrop_deck_count3 = fastdrop_number/ distribution3.length;
    const fastdrop_stimuli3 = shuffle_shoe(distribution3, fastdrop_deck_count3);
    //BLOCK 3 TEST TRIALS
    const spaceship_deck_count3 = drop_number / distribution3.length;
    const spaceship_stimuli3 = shuffle_shoe(distribution3, spaceship_deck_count3);

    //GAME BLOCK 4
    const distribution4 = distributions[index[3]];
    const means4 = [distribution4[0].value.mean , distribution4[1].value.mean];
    const stds4 = [distribution4[0].value.standardDeviation, distribution4[1].value.standardDeviation];
    const lowMean4 = Math.min(means4[0], means4[1]);
    const highMean4 = Math.max(means4[0], means4[1]);
    const narrowIndex4 = stds4.indexOf(Math.min(...stds4));
    const wideIndex4= stds4.indexOf(Math.max(...stds4));
    //FASTDROP 4 TRIALS
    const fastdrop_deck_count4 = fastdrop_number/ distribution4.length;
    const fastdrop_stimuli4 = shuffle_shoe(distribution4, fastdrop_deck_count4);
    //BLOCK 4 TEST TRIALS
    const spaceship_deck_count4 = drop_number / distribution4.length;
    const spaceship_stimuli4 = shuffle_shoe(distribution4, spaceship_deck_count4);


    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* EXPERIMENTAL PAGES */
    //splash loading screen
    var splash_1 = {
        type: "jspsych-splashmessage",
        trial_type: 'Loading',
        trial_duration: 3750,
    };

    // PIS
    var PIS = {
        type: 'jspsych-PIS',
        studyName: CUREC_studyName,
        CUREC_ID: CUREC_ID,
        version: PIS_version,
        date: PIS_date
    };
    // CONSENT
    var consent = {
        type: 'jspsych-consent',
        studyName: CUREC_studyName,
        CUREC_ID: CUREC_ID,
        version: consent_version,
        date: consent_date
    };

    //DEMOGRAPHICS
    var demographics = {
        type: 'jspsych-demographics'
    };

    /* TRAINING AND INSTRUCTION*/
    var tutorial_1 = {
        type: "jspsych-tutorial",
        isFirstTime: true
    };

    var tutorial_2 = {
        type: "jspsych-tutorial",
        isSecondTime: true
    };

    var tutorial_3 = {
        type: "jspsych-tutorial",
        isThirdTime: true
    };


    /* EXPERIMENT TIMELINE*/
    const intro_timeline = [
        splash_1, //happy
        PIS, //saving?
        consent, //saving?
        splash_1, //happy
        demographics, //saving?
        tutorial_1, //happy
        tutorial_2, //happy
        tutorial_3, //happy
        splash_1, //happy
    ];

    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*QUICK FIRE ROUND - TRIAL NUMBER 25*/
    const quickfire_timeline = [];

    let trial_contents = quickfire_stimuli.map(
        s => {
            const outcome_chance = 1;
            const good = 'images/coins.png';
            const bad = 'images/bomb.png';
            let r;

            if (/orange/i.test(s)) {
                r = Math.random() < outcome_chance ? good : bad;
            } else if (/blue/i.test(s)) {
                r = Math.random() > outcome_chance ? good : bad;
            } else {
                console.warn(`Unrecognised spaceship colour in ${s}.`);
                return;
            }
            return {
                stimulus: s,
                result: r
            }
        });

    for (let i = 1; i <= trial_number; i++) {
        const trial_details = trial_contents.pop();
        quickfire_timeline.push({
            type: 'jspsych-quickfire',
            stimuli: [trial_details.stimulus, 'images/package_image.png'],
            feedback: trial_details.result,
            trial_number: i,
            choices: ['Retrieve', 'Zap'],
            stimulus1_duration: 1500,
            gap_duration: 0,
            stimulus2_duration: 1500,
            trial_duration: 10000,
            feedback_duration: 2000,
            response_ends_trial: false,
            Zap1: 'images/zap1.png',
            Zap2: 'images/zap2.png',
        });
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Next set of instructions and splash message while loading screen*/
    var tutorial_4 = {
        type: "jspsych-tutorial",
        isFourthTime: true
    };

    const interim1_timeline = [
        tutorial_4,
        splash_1
    ];

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*FAST DROP LEARNING 1- TRIAL NUMBER 50*/
    const fastdrop_timeline = [];

    narrow_locations_1 = generateTrainingLocations(distribution1[narrowIndex].value.mean, distribution1[narrowIndex].value.standardDeviation, fastdrop_number/2);
    wide_locations_1 = generateTrainingLocations(distribution1[wideIndex].value.mean, distribution1[wideIndex].value.standardDeviation, fastdrop_number/2);



    fastdrop_stimuli.forEach(s => {
        if (/blue/i.test(s.color)) {
            s.spaceship_image = "../images/blue_spaceship.png";
            s.color1 = 'blue';
        } else {
            s.spaceship_image = "../images/orange_spaceship.png";
            s.color1 = 'orange';
            }
    });

    let fast1 = fastdrop_stimuli.map(
        s => {
            let l
            if (/wide/i.test(s.name)) {
                l= wide_locations_1.pop();
            } else {
                l = narrow_locations_1.pop();
            }
            return{
                stimulus: s,
                location:l
            }
        });

    // on each trial loop through stimuli info, pull values and pass to plugin
    fast1.forEach(s => {
        fastdrop_timeline.push({
            type: "jspsych-experimentscreen",
            trial_type: 'clear',
            confidence_trial: false,
            trial_duration: 2000,
            choices: [],
            location: s.location,
            stimulus_duration: 1500,
            spaceship_class: s.stimulus.color1,
            spaceship_image: s.stimulus.spaceship_image,
            distribution_name: s.stimulus.name,
            distribution_info: s.stimulus.value,
            banner: 1,
            banner_text: 'Please watch carefully',
            block: 0
        })
    });

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Next set of instructions and splash message while loading screen*/
    var tutorial_5 = {
        type: "jspsych-tutorial",
        isFifthTime: true
    };

    var tutorial_6 = {
        type: "jspsych-tutorial",
        isSixthTime: true
    };

    var splash_2 = {
        type: "jspsych-splashmessage",
        trial_type: 'Next',
        trial_duration: 3750,
    };

    const interim2_timeline = [
        splash_1,
        tutorial_5,
        tutorial_6,
        splash_2
    ];
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*TEST TRIALS 1*/
    const cloud1_timeline = [];
    let midline_1 = [];
    if ((lowMean1 + highMean1)/2 < 400){
        midline_1 = 350;
    } else {
        midline_1 = 450;
    }

    let bin1_1 = generateTestLocations(midline_1 - 20, midline_1 + 20, (spaceship_stimuli1.length/10)); // mid-bracket - 330-370 10%
    let bin1_2 = generateTestLocations(midline_1 - 60, midline_1 - 20, (spaceship_stimuli1.length/10)); // one left - 290-330 10%
    let bin1_3 = generateTestLocations(midline_1 - 100 , midline_1 - 60, (spaceship_stimuli1.length/10)); // two left - 250-290 10%
    let bin1_4 = generateTestLocations(midline_1 - 140 , midline_1 - 100, (spaceship_stimuli1.length/10)); // three left - 210-290 10%
    let bin1_5 = generateTestLocations(midline_1 - 180 , midline_1 - 140, (spaceship_stimuli1.length/10)); // four left - 170-210 10%
    let bin1_6 = generateTestLocations(midline_1 - 340 , midline_1 - 180, (spaceship_stimuli1.length/20)); // more left - 10-170 5%
    let bin1_7 = generateTestLocations(midline_1 + 20, midline_1 + 60, (spaceship_stimuli1.length/10)); // one right - 370 -410 10%
    let bin1_8 = generateTestLocations(midline_1 + 60, midline_1 + 100, (spaceship_stimuli1.length/10)); // two left - 410-450 10%
    let bin1_9 = generateTestLocations(midline_1 + 100, midline_1 + 140, (spaceship_stimuli1.length/10)); // three left = 450-490 10%
    let bin1_10 = generateTestLocations(midline_1 + 140, midline_1 + 180, (spaceship_stimuli1.length/10)); // four left 490-530 10%
    let bin1_11 = generateTestLocations(midline_1 + 180, midline_1 + 340, (spaceship_stimuli1.length/20)); // more right 530-790 5%

    let training_locations = bin1_1.concat(bin1_2, bin1_3, bin1_4, bin1_5, bin1_6, bin1_7, bin1_8, bin1_9, bin1_10, bin1_11);
    let training_locations1 = shuffle(training_locations);

    // on each trial loop through stimuli info, pull values and pass to plugin
    spaceship_stimuli1.forEach(s => {
        cloud1_timeline.push({
            type: "jspsych-experimentscreen",
            trial_duration: 10000,
            choices: ['Retrieve', 'Zap'],
            location: training_locations1.pop(),
            stimulus_duration: 3000,
            spaceship_class: s.color,
            distribution_name: s.name,
            distribution_info: s.value,
            confidence_trial: true,
            trial_type: 'unclear',
            block: 1,
            boundary: midline_1
        })
    });

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* block feedback */
    let feedback1_timeline = [];
    var feedback1 = {
        type: "jspsych-feedback",
        trial_type: 'first',
        filter_fun: (x) =>
            x.trial_type === "jspsych-experimentscreen" && x.block === 1
    };

    feedback1_timeline = [
        feedback1
    ];
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Next set of instructions and splash message while loading screen*/
    var tutorial_7 = {
        type: "jspsych-tutorial",
        isSeventhTime: true
    };

    const interim3_timeline = [
        splash_1,
        tutorial_7,
        splash_2
    ];
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*FAST DROP LEARNING - TRIAL NUMBER 50*/
    const fastdrop2_timeline = [];

    narrow_locations_2 = generateTrainingLocations(distribution2[narrowIndex2].value.mean, distribution2[narrowIndex2].value.standardDeviation, fastdrop_number/2);
    wide_locations_2 = generateTrainingLocations(distribution2[wideIndex2].value.mean, distribution2[wideIndex2].value.standardDeviation, fastdrop_number/2);

    fastdrop_stimuli2.forEach(s => {
        if (/blue/i.test(s.color)) {
            s.spaceship_image = "../images/blue_spaceship.png";
            s.color1 = 'blue';
        } else {
            s.spaceship_image = "../images/orange_spaceship.png";
            s.color1 = 'orange';
        }
    });

    let fast2 = fastdrop_stimuli2.map(
        s => {
            let l
            if (/wide/i.test(s.name)) {
                l= wide_locations_2.pop();
            } else {
                l = narrow_locations_2.pop();
            }
            return{
                stimulus: s,
                location:l
            }
        });

    // on each trial loop through stimuli info, pull values and pass to plugin
    fast2.forEach(s => {
        fastdrop2_timeline.push({
            type: "jspsych-experimentscreen",
            trial_type: 'clear',
            confidence_trial: false,
            trial_duration: 2000,
            choices: [],
            location: s.location,
            stimulus_duration: 1500,
            spaceship_class: s.stimulus.color1,
            spaceship_image: s.stimulus.spaceship_image,
            distribution_name: s.stimulus.name,
            distribution_info: s.stimulus.value,
            banner: 1,
            banner_text: 'Please watch carefully',
            block: -1
        })
    });
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Interim timeline*/

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*TEST TRIALS 2*/
    const cloud2_timeline = [];

    let midline_2 = [];
    if ((lowMean2 + highMean2)/2 < 400){
        midline_2 = 350;
    } else {
        midline_2 = 450;
    }

    let bin2_1 = generateTestLocations(midline_2 - 20, midline_2 + 20, (spaceship_stimuli2.length/10)); // mid-bracket - 330-370 10%
    let bin2_2 = generateTestLocations(midline_2 - 60, midline_2 - 20, (spaceship_stimuli2.length/10)); // one left - 290-330 10%
    let bin2_3 = generateTestLocations(midline_2 - 100 , midline_2 - 60, (spaceship_stimuli2.length/10)); // two left - 250-290 10%
    let bin2_4 = generateTestLocations(midline_2 - 140 , midline_2 - 100, (spaceship_stimuli2.length/10)); // three left - 210-290 10%
    let bin2_5 = generateTestLocations(midline_2 - 180 , midline_2 - 140, (spaceship_stimuli2.length/10)); // four left - 170-210 10%
    let bin2_6 = generateTestLocations(midline_2 - 340 , midline_2 - 180, (spaceship_stimuli2.length/20)); // more left - 10-170 5%
    let bin2_7 = generateTestLocations(midline_2 + 20, midline_2 + 60, (spaceship_stimuli2.length/10)); // one right - 370 -410 10%
    let bin2_8 = generateTestLocations(midline_2 + 60, midline_2 + 100, (spaceship_stimuli2.length/10)); // two left - 410-450 10%
    let bin2_9 = generateTestLocations(midline_2 + 100, midline_2 + 140, (spaceship_stimuli2.length/10)); // three left = 450-490 10%
    let bin2_10 = generateTestLocations(midline_2 + 140, midline_2 + 180, (spaceship_stimuli2.length/10)); // four left 490-530 10%
    let bin2_11 = generateTestLocations(midline_2 + 180, midline_2 + 340, (spaceship_stimuli2.length/20)); // more right 530-790 5%

    let training2_locations = bin2_1.concat(bin2_2, bin2_3, bin2_4, bin2_5, bin2_6, bin2_7, bin2_8, bin2_9, bin2_10, bin2_11);
    let training_locations2 = shuffle(training2_locations);
    // on each trial loop through stimuli info, pull values and pass to plugin
    spaceship_stimuli2.forEach(s => {
        do{
            s.location = s.value.random(1)[0];
        } while (s.location < lowMean2 | s.location > highMean2)
        cloud2_timeline.push({
            type: "jspsych-experimentscreen",
            trial_duration: 10000,
            choices: ['Retrieve', 'Zap'],
            location: training_locations2.pop(),
            stimulus_duration: 3000,
            spaceship_class: s.color,
            distribution_name: s.name,
            distribution_info: s.value,
            confidence_trial: true,
            trial_type: 'unclear',
            block: 2,
            boundary: midline_2
        })
    });
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* block feedback */
    var feedback2_timeline = [];

    var feedback2 = {
        type: "jspsych-feedback",
        trial_type: 'second',
        filter_fun: (x) =>
            x.trial_type === "jspsych-experimentscreen" && x.block === 2
    };

    feedback2_timeline = [
        feedback2
    ];


    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Next set of instructions and splash message while loading screen*/


    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*FAST DROP LEARNING - TRIAL NUMBER 50*/
    const fastdrop3_timeline = [];

    narrow_locations_3 = generateTrainingLocations(distribution3[narrowIndex3].value.mean, distribution3[narrowIndex3].value.standardDeviation, fastdrop_number/2);
    wide_locations_3 = generateTrainingLocations(distribution3[wideIndex3].value.mean, distribution3[wideIndex3].value.standardDeviation, fastdrop_number/2);

    fastdrop_stimuli3.forEach(s => {
        if (/blue/i.test(s.color)) {
            s.spaceship_image = "../images/blue_spaceship.png";
            s.color1 = 'blue';
        } else {
            s.spaceship_image = "../images/orange_spaceship.png";
            s.color1 = 'orange';
        }
    });

    let fast3 = fastdrop_stimuli3.map(
        s => {
            let l
            if (/wide/i.test(s.name)) {
                l= wide_locations_3.pop();
            } else {
                l = narrow_locations_3.pop();
            }
            return{
                stimulus: s,
                location:l
            }
        });

    // on each trial loop through stimuli info, pull values and pass to plugin
    fast3.forEach(s => {
        fastdrop3_timeline.push({
            type: "jspsych-experimentscreen",
            trial_type: 'clear',
            confidence_trial: false,
            trial_duration: 2000,
            choices: [],
            location: s.location,
            stimulus_duration: 1500,
            spaceship_class: s.stimulus.color1,
            spaceship_image: s.stimulus.spaceship_image,
            distribution_name: s.stimulus.name,
            distribution_info: s.stimulus.value,
            banner: 1,
            banner_text: 'Please watch carefully',
            block: -2
        })
    });
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Interim*/

    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*TEST TRIALS 3*/
    const cloud3_timeline = [];

    let midline_3 = [];
    if ((lowMean3 + highMean3)/2 < 400){
        midline_3 = 350;
    } else {
        midline_3 = 450;
    }

    let bin3_1 = generateTestLocations(midline_3 - 20, midline_3 + 20, (spaceship_stimuli3.length/10)); // mid-bracket - 330-370 10%
    let bin3_2 = generateTestLocations(midline_3 - 60, midline_3 - 20, (spaceship_stimuli3.length/10)); // one left - 290-330 10%
    let bin3_3 = generateTestLocations(midline_3 - 100 , midline_3 - 60, (spaceship_stimuli3.length/10)); // two left - 250-290 10%
    let bin3_4 = generateTestLocations(midline_3 - 140 , midline_3 - 100, (spaceship_stimuli3.length/10)); // three left - 210-290 10%
    let bin3_5 = generateTestLocations(midline_3 - 180 , midline_3 - 140, (spaceship_stimuli3.length/10)); // four left - 170-210 10%
    let bin3_6 = generateTestLocations(midline_3 - 340 , midline_3 - 180, (spaceship_stimuli3.length/20)); // more left - 10-170 5%
    let bin3_7 = generateTestLocations(midline_3 + 20, midline_3 + 60, (spaceship_stimuli3.length/10)); // one right - 370 -410 10%
    let bin3_8 = generateTestLocations(midline_3 + 60, midline_3 + 100, (spaceship_stimuli3.length/10)); // two left - 410-450 10%
    let bin3_9 = generateTestLocations(midline_3 + 100, midline_3 + 140, (spaceship_stimuli3.length/10)); // three left = 450-490 10%
    let bin3_10 = generateTestLocations(midline_3 + 140, midline_3 + 180, (spaceship_stimuli3.length/10)); // four left 490-530 10%
    let bin3_11 = generateTestLocations(midline_3 + 180, midline_3 + 340, (spaceship_stimuli3.length/20)); // more right 530-790 5%

    let training3_locations = bin3_1.concat(bin3_2, bin3_3, bin3_4, bin3_5, bin3_6, bin3_7, bin3_8, bin3_9, bin3_10, bin3_11);
    let training_locations3 = shuffle(training3_locations);
    // on each trial loop through stimuli info, pull values and pass to plugin
    spaceship_stimuli3.forEach(s => {
        do{
            s.location = s.value.random(1)[0];
        } while (s.location < lowMean3 | s.location > highMean3)
        cloud3_timeline.push({
            type: "jspsych-experimentscreen",
            trial_duration: 10000,
            choices: ['Retrieve', 'Zap'],
            location: training_locations3.pop(),
            stimulus_duration: 3000,
            spaceship_class: s.color,
            distribution_name: s.name,
            distribution_info: s.value,
            confidence_trial: true,
            trial_type: 'unclear',
            block: 3,
            boundary: midline_3
        })
    });
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* block feedback */
    var feedback3_timeline = [];

    var feedback3 = {
        type: "jspsych-feedback",
        trial_type: 'third',
        filter_fun: (x) =>
            x.trial_type === "jspsych-experimentscreen" && x.block === 3
    };

    feedback3_timeline = [
        feedback3
    ];


    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Interim*/

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*FAST DROP LEARNING - TRIAL NUMBER 50*/
    const fastdrop4_timeline = [];
    narrow_locations_4 = generateTrainingLocations(distribution4[narrowIndex4].value.mean, distribution4[narrowIndex4].value.standardDeviation, fastdrop_number/2);
    wide_locations_4 = generateTrainingLocations(distribution4[wideIndex4].value.mean, distribution4[wideIndex4].value.standardDeviation, fastdrop_number/2);

    fastdrop_stimuli4.forEach(s => {
        if (/blue/i.test(s.color)) {
            s.spaceship_image = "../images/blue_spaceship.png";
            s.color1 = 'blue';

        } else {
            s.spaceship_image = "../images/orange_spaceship.png";
            s.color1 = 'orange';
        }

    });

    let fast4 = fastdrop_stimuli4.map(
        s => {
            let l
            if (/wide/i.test(s.name)) {
                l= wide_locations_4.pop();
            } else {
                l = narrow_locations_4.pop();
            }
            return{
                stimulus: s,
                location:l
            }
        });

    // on each trial loop through stimuli info, pull values and pass to plugin
    fast4.forEach(s => {
        fastdrop4_timeline.push({
            type: "jspsych-experimentscreen",
            trial_type: 'clear',
            confidence_trial: false,
            trial_duration: 2000,
            choices: [],
            location: s.location,
            stimulus_duration: 1500,
            spaceship_class: s.stimulus.color1,
            spaceship_image: s.stimulus.spaceship_image,
            distribution_name: s.stimulus.name,
            distribution_info: s.stimulus.value,
            banner: 1,
            banner_text: 'Please watch carefully',
            block: -3
        })
    });
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Interim*/

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*TEST TRIALS 4*/
    const cloud4_timeline = [];

    let midline_4 = [];
    if ((lowMean4 + highMean4)/2 < 400){
        midline_4 = 350;
    } else {
        midline_4 = 450;
    }

    let bin4_1 = generateTestLocations(midline_4 - 20, midline_4 + 20, (spaceship_stimuli4.length/10)); // mid-bracket - 330-370 10%
    let bin4_2 = generateTestLocations(midline_4 - 60, midline_4 - 20, (spaceship_stimuli4.length/10)); // one left - 290-330 10%
    let bin4_3 = generateTestLocations(midline_4 - 100 , midline_4 - 60, (spaceship_stimuli4.length/10)); // two left - 250-290 10%
    let bin4_4 = generateTestLocations(midline_4 - 140 , midline_4 - 100, (spaceship_stimuli4.length/10)); // three left - 210-290 10%
    let bin4_5 = generateTestLocations(midline_4 - 180 , midline_4 - 140, (spaceship_stimuli4.length/10)); // four left - 170-210 10%
    let bin4_6 = generateTestLocations(midline_4 - 340 , midline_4 - 180, (spaceship_stimuli4.length/20)); // more left - 10-170 5%
    let bin4_7 = generateTestLocations(midline_4 + 20, midline_4 + 60, (spaceship_stimuli4.length/10)); // one right - 370 -410 10%
    let bin4_8 = generateTestLocations(midline_4 + 60, midline_4 + 100, (spaceship_stimuli4.length/10)); // two left - 410-450 10%
    let bin4_9 = generateTestLocations(midline_4 + 100, midline_4 + 140, (spaceship_stimuli4.length/10)); // three left = 450-490 10%
    let bin4_10 = generateTestLocations(midline_4 + 140, midline_4 + 180, (spaceship_stimuli4.length/10)); // four left 490-530 10%
    let bin4_11 = generateTestLocations(midline_4 + 180, midline_4 + 340, (spaceship_stimuli4.length/20)); // more right 530-790 5%

    let training4_locations = bin4_1.concat(bin4_2, bin4_3, bin4_4, bin4_5, bin4_6, bin4_7, bin4_8, bin4_9, bin4_10, bin4_11);
    let training_locations4 = shuffle(training4_locations);
    // on each trial loop through stimuli info, pull values and pass to plugin
    spaceship_stimuli4.forEach(s => {
        cloud4_timeline.push({
            type: "jspsych-experimentscreen",
            trial_duration: 10000,
            choices: ['Retrieve', 'Zap'],
            location: training_locations4.pop(),
            stimulus_duration: 3000,
            spaceship_class: s.color,
            distribution_name: s.name,
            distribution_info: s.value,
            confidence_trial: true,
            trial_type: 'unclear',
            block: 4,
            boundary: midline_4
        })
    });
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* block feedback */
    var feedback4_timeline = [];

    var feedback4 = {
        type: "jspsych-feedback",
        trial_type: 'last',
        filter_fun: (x) =>
            x.trial_type === "jspsych-experimentscreen" && x.block === 4
    };

    feedback4_timeline = [
        feedback4
    ];
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*sign off experiment*/
    var splash_3 = {
        type: "jspsych-splashmessage",
        trial_type: 'Last',
        trial_duration: 3000,
    };

    var feedbackForm = {
        type: 'jspsych-feedback-form',
    };

    var end_experiment = {
        type: "jspsych-lastScreen",
    };

    end_timeline = [
        splash_3,
        feedbackForm,
        end_experiment
    ];

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    var interim_fast = {
        type: 'jspsych-splashmessage',
        trial_type: 'fastdrop',
        trial_duration: 3000
    };
    interim_fast =[
        interim_fast
    ];

    var interim_cloud = {
        type: 'jspsych-splashmessage',
        trial_type: 'cloud',
        trial_duration: 3000
    };
    interim_cloud = [
        interim_cloud
    ];
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* Set up timeline and launch experiment*/

    const timeline = [
        ...intro_timeline, //happy, check on saving of pp info and consent etc
        ...quickfire_timeline, //happy
        ...interim1_timeline, //gif will need updating, has been removed for now.
        ...fastdrop_timeline, //
        ...interim2_timeline, //
        ...cloud1_timeline, //happy - slider labels could use more padding but okay
        ...feedback1_timeline, //Happy
        ...interim3_timeline, //little bit messy on screen but likely updated
        ...interim_fast,
        ...fastdrop2_timeline, //
        ...interim_cloud,
        ...cloud2_timeline, //happy - slider labels could use more padding but okay
        ...feedback2_timeline,//
        ...interim3_timeline,//little bit messy on screen but likely updated
        ...interim_fast,
        ...fastdrop3_timeline, //
        ...interim_cloud,
        ...cloud3_timeline, //happy - slider labels could use more padding but okay
        ...feedback3_timeline, //
        ...interim3_timeline,//
        ...interim_fast,
        ...fastdrop4_timeline, //
        ...interim_cloud,
        ...cloud4_timeline, //happy - slider labels could use more padding but okay
        ...feedback4_timeline, //
        ...end_timeline
    ];

    test_save()
        .then(()=>{
            /* start the experiment */
            jsPsych.init({
                timeline: timeline,
                on_trial_finish: save_csv,
                on_finish: save_csv
            });
        });

    /**
     * Save the jsPsych CSV output to the server
     */
    function save_csv() {
        if(!window.experiment_metadata) {
            // Get a user ID
            let id = jsPsych.data.getURLVariable('PROLIFIC_PID');
            if(typeof id !== "string")
                id = "ID" + (10 + Math.floor(Math.random() * 89)) +
                    "T" + Math.floor(performance.timeOrigin);

            jsPsych.data.addProperties({user_id: id});

            // Fetch all the experiment data and send it to the server
            window.experiment_metadata = {
                user_id: id,
                experiment: 'zapBox',
                version: [0, 2, 0]
            };
        }

        const data = {
            ...window.experiment_metadata,
            csv: jsPsych.data.get().csv()
        };

        fetch(
            "savecsv.php",
            {
                method: "POST",
                body: JSON.stringify(data),
                type: 'application/json'
            }
        )
            .then(r => r.text())
            .then(b => console.log(b));
    }

    /**
     * Test the ability to save files on the server
     */
    function test_save() {
        return fetch(
            "savecsv.php",
            {
                method: "POST",
                body: JSON.stringify({user_id: "test_id"}),
                type: 'application/json'
            }
        )
            .then(r => {
                if (r.status !== 200) {
                    document.getElementById('save-error').classList.add('show');
                    throw new Error('Problem saving data');
                }
                else
                    console.log('Save data test okay!');
            });
    }

</script>
</body>
</html>