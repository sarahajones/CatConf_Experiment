<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CatConf-Experiment</title>

    <!--jsPsych-->
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-same-different-image.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-slider-response.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css">

    <!--jQuery and jQuery plugins -->
    <script src="scripts/external/jquery-3.4.1.min.js"></script>
    <script src="scripts/external/jquery-3.4.1.js"></script>
    <script src="scripts/external/jquery.mousewheel.min.js"></script>
    <script src="scripts/external/jquery.scrollify.js"></script>

    <!--custom JS: trials-->
    <script src="scripts/jspsych-PIS.js"></script>
    <script src="scripts/jspsych-consent.js"></script>
    <script src="scripts/jspsych-tutorial.js"></script>
    <script src="scripts/jspsych-splashmessage.js"></script>
    <script src="scripts/jspsych-quickfire.js"></script>
    <script src="scripts/jspsych-experimentscreen.js"></script>
    <script src="scripts/jspsych-demographics.js"></script>
    <script src="scripts/jspsych-feedback.js"></script>

    <!--custom JS: helpers-->
    <script src="scripts/helper-functions.js"></script>
    <script src="scripts/box-muller.js"></script>
    <script src="scripts/gaussian.js"></script>


    <!--custom CSS-->
    <link href="CSS/styles.css" rel="stylesheet" type="text/css">
    <link href="CSS/experimentscreen.css" rel="stylesheet" type="text/css">

</head>

<body class="main">

<script>

    /* EXPERIMENT INFORMATION */
    var CUREC_studyName = 'An investigation into decision confidence and category choices';
    var CUREC_ID = 'R68879/RE001';
    var PIS_version = '1.0';
    var PIS_date = 'August 2020';
    var consent_version = '1.0';
    var consent_date = 'August 2020';

    /* PreLOAD IMAGES FOR SPEED */
    var images = [
        'images/oxford-logo.jpg' +
        'images/checkmark-black.svg' +
        'images/checkmark-white.svg' +
        'images/space_invaders.png' +
        'images/green_spaceship.png' +
        'images/blue_spaceship.png' +
        'images/orange_spaceship.png' +
        'images/bomb.png' +
        'images/coins.png'
    ];

    var dataObject = {
        //set up and intro
        CUREC_ID: CUREC_ID,
        PIS_version: PIS_version,
        PIS_date: PIS_date,
        PIS_acknowledged: undefined,
        consent_version: consent_version,
        consent_date: consent_date,
        consented: undefined,

        //demographics
        age: undefined,
        gender: undefined,
        handedness: undefined,
        demographicsRTs: [],
        demographics_duration: 0,

        // quickfire trials
        quickfire_stimulus: [],
        quickfire_feedback: [],
        quickfire_response_time: [],
        quickfire_delta_response_time: [],
        quickfire_delta_feedback_time: [],
        quickfire_response:[],
        quickfire_response_button_label: [],

        //fast drops


        // test trials
        testtrial_stimulus: [],
        testtrial_trial_type: [],
        testtrial_distribution_name: [],
        testtrial_spaceship_class: [],
        testtrial_stimulus: [],
        testtrial_stimulus_location: [],
        testtrial_response_time: [],
        testtrial_confidence_response_time: [],
        testtrial_delta_response_time: [],
        testtrial_delta_confidence_response_time: [],
        testtrial_delta_feedback_time: [],
        testtrial_response: [],
        testtrial_response_button_label: [],
        testtrial_confidence: [],
        testtrial_correct: [],
        testtrial_incorrect: [],

    };
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* EXPERIMENTAL PAGES */
    //splash loading screen
    var splash_0 = {
        type: "jspsych-splashmessage",
        trial_type: 'Loading',
        //display_duration: 3500,
        trial_duration: 3750,
    };

    // PIS
    var PIS = {
        type: 'jspsych-PIS',
        studyName: CUREC_studyName,
        CUREC_ID: CUREC_ID,
        version: PIS_version,
        date: PIS_date
    };
    // CONSENT
    var consent = {
        type: 'jspsych-consent',
        studyName: CUREC_studyName,
        CUREC_ID: CUREC_ID,
        version: consent_version,
        date: consent_date
    };

    //DEMOGRAPHICS
    var demographics = {
        type: 'jspsych-demographics'
    };

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* TRAINING AND INSTRUCTION*/
    var tutorial_1 = {
        type: "jspsych-tutorial",
        isFirstTime: true
    };

    var tutorial_2 = {
        type: "jspsych-tutorial",
        isSecondTime: true
    };

    var tutorial_3 = {
        type: "jspsych-tutorial",
        isThirdTime: true
    };

    var splash_1 = {
        type: "jspsych-splashmessage",
        trial_type: 'Loading',
        //display_duration: 3500,
        trial_duration: 3750,
    };
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* EXPERIMENT TIMELINE*/
    const intro_timeline = [
        splash_0,
        PIS,
        consent,
        splash_0,
        demographics,
        tutorial_1,
        tutorial_2,
        tutorial_3,
        splash_1,
    ];
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*QUICK FIRE ROUND - TRIAL NUMBER 20*/
    const quickfire_timeline = [];
    const trial_number = 20; // No magic numbers! :)

    // construct deck
    quickfire_stimuli = [
        'images/orange_spaceship.png',
        'images/blue_spaceship.png'
    ];

    const deck_count = trial_number / quickfire_stimuli.length;

    // shuffle deck
    quickfire_stimuli = shuffle_shoe(quickfire_stimuli, deck_count);

    let trial_contents = quickfire_stimuli.map(
        s => {
            const outcome_chance = 1;
            const good = 'images/coins.png';
            const bad = 'images/bomb.png';
            let r;

            if(/orange/i.test(s)) {
                r = Math.random() < outcome_chance ? good : bad;
            } else if(/blue/i.test(s)) {
                r = Math.random() > outcome_chance ? good : bad;
            } else {
                console.warn(`Unrecognised spaceship colour in ${s}.`);
                return;
            }
            return {
                stimulus: s,
                result: r
            }
        });

    for(let i=1; i <= trial_number; i++) {
        const trial_details = trial_contents.pop();
        quickfire_timeline.push({
            type: 'jspsych-quickfire',
            stimuli: [trial_details.stimulus, 'images/package_image.png'],
            feedback: trial_details.result,
            trial_number: i,
            choices: ['Retrieve', 'Zap'],
            stimulus1_duration: 1500,
            gap_duration: 0,
            stimulus2_duration: 1500,
            trial_duration: 5000,
            feedback_duration: 2000,
            response_ends_trial: false,
        });
    }
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Next set of instructions and splash message while loading screen*/

    var tutorial_4 = {
        type: "jspsych-tutorial",
        isFourthTime: true
    };

    var splash_2 = {
        type: "jspsych-splashmessage",
        trial_type: 'Loading',
        //display_duration: 3500,
        trial_duration: 3750,
    };

    const interim1_timeline = [
        tutorial_4,
        splash_2
    ];


    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*FAST DROP LEARNING - TRIAL NUMBER 50*/
    const fastdrop_timeline = [];
    const fastdrop_number = 50; //amount of drops

    const fastdrop_distribution = [
        {name: 'narrow', value: gaussian(200, 5000), color: 'blue'},
        {name: 'wide', value: gaussian(500, 10000), color: 'orange'}
    ];

    // create deck count for spaceship drops
    const fastdrop_deck_count = fastdrop_number / fastdrop_distribution.length;

    // shuffle deck
    const fastdrop_stimuli = shuffle_shoe(fastdrop_distribution, fastdrop_deck_count);


    // on each trial loop through stimuli info, pull values and pass to plugin
    fastdrop_stimuli.forEach(s => {
        if (s.color ==='blue'){
            s.spaceship_image = "../images/blue_spaceship.png"
        } else {
            s.spaceship_image = "../images/orange_spaceship.png"
        }
        fastdrop_timeline.push({
            type: "jspsych-experimentscreen",
            trial_type: 'clear',
            confidence_trial: false,
            trial_duration: 2000,
            choices: [],
            location: s.value.random(1)[0],
            stimulus_duration: 1500,
            spaceship_class: s.color,
            spaceship_image: s.spaceship_image,
            distribution_name: s.name,
            banner: 1,
            banner_text: 'Please watch carefully'
        })
    });
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*Next set of instructions and splash message while loading screen*/

    var tutorial_5 = {
        type: "jspsych-tutorial",
        isFifthTime: true
    };

    var tutorial_6 = {
        type: "jspsych-tutorial",
        isSixthTime: true
    };

    var splash_3= {
        type: "jspsych-splashmessage",
        trial_type: 'Next',
        //display_duration: 3500,
        trial_duration: 3750,
    };

    const interim2_timeline = [
        splash_2,
        tutorial_5,
        tutorial_6,
        splash_3
    ];
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*TEST TRIALS 1*/
    const cloud1_timeline = [];

    let Block_score_correct = [];
    let Block_score_incorrect = [];

    const drop_number1 = 25; //amount of drops

    const distribution1 = [
        {name: 'narrow', value: gaussian(200, 5000), color: 'greenyellow'},
        {name: 'wide', value: gaussian(500, 10000), color: 'red'}
    ];

    // create deck count for spaceship drops
    const spaceship_deck_count1 = drop_number1 / distribution1.length;

    // shuffle deck
    const spaceship_stimuli1 = shuffle_shoe(distribution1, spaceship_deck_count1);


    // on each trial loop through stimuli info, pull values and pass to plugin
    spaceship_stimuli1.forEach(s => {
        cloud1_timeline.push({
            type: "jspsych-experimentscreen",
            trial_duration: 5000,
            choices: ['Retrieve', 'Zap'],
            location: s.value.random(1)[0],
            stimulus_duration: 3000,
            spaceship_class: s.color,
            distribution_name: s.name,
            confidence_trial: true,
            trial_type: 'unclear'
        })
    });

    var Block1_ScoreCorrect = Block_score_correct;
    var Block1_ScoreIncorrect = Block_score_incorrect;
    var Block1_total = Block_score_correct;

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* block feedback */
    var feedback1 = {
        type: "jspsych-feedback",
        isFirstTime: true,
        correct: Block1_ScoreCorrect,
        incorrect: Block1_ScoreIncorrect,
        total: Block1_total,
        trials: drop_number1,
    };

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*TEST TRIALS 2*/
    const cloud2_timeline = [];

    Block_score_correct = [];
    Block_score_incorrect = [];

    const drop_number2 = 25; //amount of drops

    const distribution2 = [
        {name: 'narrow', value: gaussian(200, 5000), color: 'greenyellow'},
        {name: 'wide', value: gaussian(500, 10000), color: 'red'}
    ];

    // create deck count for spaceship drops
    const spaceship_deck_count2 = drop_number2 / distribution2.length;

    // shuffle deck
    const spaceship_stimuli2 = shuffle_shoe(distribution2, spaceship_deck_count2);


    // on each trial loop through stimuli info, pull values and pass to plugin
    spaceship_stimuli2.forEach(s => {
        cloud2_timeline.push({
            type: "jspsych-experimentscreen",
            trial_duration: 5000,
            choices: ['Retrieve', 'Zap'],
            location: s.value.random(1)[0],
            stimulus_duration: 3000,
            spaceship_class: s.color,
            distribution_name: s.name,
            confidence_trial: true,
            trial_type: 'unclear'
        })
    });

    var Block2_ScoreCorrect = Block_score_correct;
    var Block2_ScoreIncorrect = Block_score_incorrect;
    var Block2_total = Block_score_correct;

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* block feedback */
    var feedback2 = {
        type: "jspsych-feedback",
        isFirstTime: true,
        correct: Block2_ScoreCorrect,
        incorrect: Block2_ScoreIncorrect,
        total: Block2_total,
        trials: drop_number2,
    };
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /*TEST TRIALS 3*/
    const cloud3_timeline = [];

    Block_score_correct = [];
    Block_score_incorrect = [];

    const drop_number3 = 25; //amount of drops

    const distribution3 = [
        {name: 'narrow', value: gaussian(200, 5000), color: 'greenyellow'},
        {name: 'wide', value: gaussian(500, 10000), color: 'red'}
    ];

    // create deck count for spaceship drops
    const spaceship_deck_count3 = drop_number3 / distribution3.length;

    // shuffle deck
    const spaceship_stimuli3 = shuffle_shoe(distribution3, spaceship_deck_count3);


    // on each trial loop through stimuli info, pull values and pass to plugin
    spaceship_stimuli3.forEach(s => {
        cloud3_timeline.push({
            type: "jspsych-experimentscreen",
            trial_duration: 5000,
            choices: ['Retrieve', 'Zap'],
            location: s.value.random(1)[0],
            stimulus_duration: 3000,
            spaceship_class: s.color,
            distribution_name: s.name,
            confidence_trial: true,
            trial_type: 'unclear'
        })
    });

    var Block3_ScoreCorrect = Block_score_correct;
    var Block3_ScoreIncorrect = Block_score_incorrect;
    var Block3_total = Block_score_correct;

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* block feedback */
    var feedback3 = {
        type: "jspsych-feedback",
        isFirstTime: true,
        correct: Block3_ScoreCorrect,
        incorrect: Block3_ScoreIncorrect,
        total: Block3_total,
        trials: drop_number3,
    };
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /* Set up timeline and launch experiment*/

    const timeline = [
        //...intro_timeline,
        //...quickfire_timeline,
        //...interim1_timeline,
        //...fastdrop_timeline,
        //...interim2_timeline,
        ...cloud1_timeline,
        //...feedback1,
        ...cloud2_timeline,
        //...feedback2,
        ...cloud3_timeline,
        //...feedback3
    ];
    console.log({timeline});

    /* start the experiment */
    jsPsych.init({
        timeline: timeline
    })


</script>
</body>
</html>